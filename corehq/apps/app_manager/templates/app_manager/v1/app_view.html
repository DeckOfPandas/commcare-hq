{% extends "app_manager/v1/managed_app.html" %}
{% load xforms_extras %}
{% load hq_shared_tags %}
{% load i18n %}
{% load crispy_forms_tags %}

{% block head %}{{ block.super }}
    {% include 'analytics/fullstory.html' %}
{% endblock %}
{% block js %}{{ block.super }}
    <script src="{% static 'app_manager/js/commcaresettings.js' %}"></script>
    <script src="{% static 'hqwebapp/js/bulk_upload_file.js' %}"></script>
    <script src="{% static 'app_manager/js/supported-languages.js' %}"></script>
    <script src="{% static 'app_manager/js/password_setter.jquery.js' %}"></script>
    <script src="{% static "hqmedia/js/hqmediauploaders.js" %}"></script>
    <script src="{% static 'hqmedia/js/hqmedia.reference_controller.js' %}"></script>
    <script src="{% static "clipboard/dist/clipboard.js" %}"></script>
    <script src="{% static "jsdiff/diff.js" %}"></script>

    <script src="{% static 'app_manager/js/app_view.js' %}"></script>
    {% if app.get_doc_type == "Application" %}
        <script src="{% static 'translations/js/translations.js' %}"></script>
        <script src="{% static 'app_manager/js/app_view_application.js' %}"></script>
    {% endif %}

    {% if linked_apps_enabled %}
        <script src="{% static 'app_manager/js/linked_whitelist.js' %}"></script>
    {% endif %}

    {# these scripts are for releases.html, but including them there causes hard-to-reproduce problems #}
    <script src="{% static 'app_manager/js/app_manager_utils.js' %}"></script>
    <script src="{% static 'app_manager/js/download_async_modal.js' %}"></script>
    <script src="{% static 'app_manager/js/releases.js' %}"></script>
    <script src="{% static 'app_manager/js/app_diff.js' %}"></script>
    <script src="{% static 'app_manager/js/language-profiles.js' %}"></script>
{% endblock %}
{% block js-inline %}
    {{ block.super }}
    <script>
        {% if not app.is_remote_app and app.get_doc_type != 'LinkedApplication' %}
            {% if linked_apps_enabled %}
             $(function () {
                var domains = {{ app.linked_whitelist|JSON }};
                var save = '{% url "update_linked_whitelist" domain app.id %}';
                var LinkedWhitelist = hqImport('app_manager/js/linked_whitelist.js').LinkedWhitelist;
                linkedWhitelist = new LinkedWhitelist(domains, save);
                $('#whitelist-tab').koApplyBindings(linkedWhitelist);
             });
            {% endif %}
        $(function () {
            var multimedia_tab = (function () {
                var self = {};
                self.load_state = ko.observable(null);
                self.multimedia_page_html = ko.observable('');
                self.load_if_necessary = function () {
                    if (!self.load_state() || self.load_state() === 'error') {
                        self.load_state('loading');
                        $.ajax({
                            url: '{% url 'app_multimedia_ajax' domain app.get_id %}',
                            success: function(content) {
                                self.load_state('loaded');
                                self.multimedia_page_html(content);
                            },
                            error: function() {
                                alert('Oops, there was a problem loading this section. Please try again.');
                                self.load_state('error');
                            },
                        });
                    }
                };
                return self;
            }());
            $("#multimedia").koApplyBindings(multimedia_tab);
            $('#demand-multimedia').on('shown.bs.tab', function () {
                if (multimedia_tab.load_state() === null) {
                    multimedia_tab.load_if_necessary();
                }
            });
        });
        {% endif %}

        // Releases page ajax: used in app manager v1 only
        $(function () {
            var state = "",
                $main = $("#releases"),
                $loading = $main.find(".hq-loading").remove(),
                $loadingError = $main.find(".hq-loading-error").remove();

            $('#demand-releases').on('shown.bs.tab', function () {
                if (state === "loading" || state === "loaded") {
                    return;
                }
                state = "loading";

                // If the content takes a noticeable amount of time to load, show a spinner
                var showSpinner = true;
                _.delay(function() {
                    if (showSpinner) {
                        $main.html($loading.html());
                    }
                }, 100);

                // Load the content
                $.ajax({
                    url: "{% url 'release_manager_ajax' domain app.get_id %}?limit={{fetchLimit}}",
                    success: function(content) {
                        state = "loaded";
                        showSpinner = false;
                        $main.html(content);
                        COMMCAREHQ.initBlock($main);
                        analytics.workflow('Visited the Release Manager');

                        var initial_page_data = hqImport("hqwebapp/js/initial_page_data.js").get;

                        // Main releases/versions tab
                        var o = {
                            currentAppVersion: {% if app.version %}{{ app.version }}{% else %}-1{% endif %},
                            recipient_contacts: {{ sms_contacts|JSON }},
                            download_modal_id: '#download-zip-modal',
                            fetchLimit: {{ fetchLimit }},
                        };
                        var el = $('#releases-table');
                        var ReleasesMain = hqImport('app_manager/js/releases.js').ReleasesMain;
                        var releasesMain = new ReleasesMain(o);
                        _.defer(function(){ releasesMain.getMoreSavedApps(false); });
                        el.koApplyBindings(releasesMain);

                        // Build profiles
                        $profileManager = $("#profiles-tab");
                        if ($profileManager.length) {
                            var app_langs = initial_page_data('langs');
                            var app_profiles = initial_page_data('build_profiles');
                            var ProfileManager = hqImport('app_manager/js/language-profiles.js').ProfileManager;
                            $profileManager.koApplyBindings(new ProfileManager(app_profiles, app_langs));
                        }

                        // App diff
                        var appDiff = hqImport('app_manager/js/app_diff.js').init('#app-diff-modal .modal-body')
                        $('#recent-changes-btn').on('click', function (e) {
                            appDiff.renderDiff({{ app.id|JSON }}, {{ latest_build_id|JSON }});
                        });
                    },
                    error: function() {
                        state = "error";
                        showSpinner = false;
                        $main.html($loadingError.html());
                    },
                });
            });
        });

        var HQMediaUploaders = hqImport("hqmedia/js/hqmediauploaders.js").get();
        var refs = {{ refs|JSON }};
        var media_info = {{ media_info|JSON }};
        var image_refs = {};
        for (var slug in refs) {
            image_refs[slug] = new ImageReference(refs[slug]);
            image_refs[slug].upload_controller = HQMediaUploaders[slug];
            image_refs[slug].setObjReference(media_info[slug]);
        }
        function urlFromLogo(slug) {
            return image_refs[slug].url;
        }
        function thumbUrlFromLogo(slug) {
            return image_refs[slug].thumb_url;
        }
        function triggerUploadForLogo(slug) {
            if(image_refs[slug]) {
                image_refs[slug].triggerUpload();
            }
        }
        function uploadCompleteForLogo(slug, response) {
            if(image_refs[slug]) {
                image_refs[slug].uploadComplete(null, null, response);
            }
        }
        function getPathFromSlug(slug) {
            return image_refs[slug].path;
        }
        function removeLogo(slug) {
            $.post(
                '{% url "hqmedia_remove_logo" domain app.id %}',
                {
                    logo_slug: slug
                },
                function(data, status) {
                    if(status == 'success'){
                        image_refs[slug].url("");
                    }
                }
            );
        }
        function anonymousAppUrl() {
            return '{{ app.anonymous_cloudcare_url }}';
        }
    </script>
{% endblock %}

{% block title %}
    {% if app.name %}
        {{ app.name|html_name }}
    {% else %}
        {% trans 'Applications' %}
    {% endif %}
{% endblock %}

{% block form-view %}
    {% initial_page_data 'build_profiles' app.build_profiles %}
    {% initial_page_data 'app_view_options' app_view_options %}
    {% initial_page_data 'domain_names' domain_names %}
    {% initial_page_data 'is_remote_app' app.is_remote_app %}
    {% initial_page_data 'is_superuser' request.user.is_superuser %}
    {% initial_page_data 'lang' lang %}
    {% initial_page_data 'langs' app.langs %}
    {% initial_page_data 'sessionid' request.COOKIES.sessionid %}
    {% initial_page_data 'swfURL' 'hqmedia/MediaUploader/flashuploader.swf'|static %}
    {% initial_page_data 'translations' translations %}
    {% initial_page_data 'uploaders' uploaders_js %}
    {% registerurl "edit_app_langs" domain app.id %}
    {% registerurl "edit_app_ui_translations" domain app.id %}
    {% registerurl "get_app_ui_translations" domain %}
    {% registerurl "toggle_diff" domain %}

    {# release page URLs #}
    {% registerurl "paginate_releases" domain app.id %}
    {% registerurl "delete_copy" domain app.id %}
    {% registerurl "download_jad" domain '---' %}
    {% registerurl "download_jar" domain '---' %}
    {% registerurl "odk_install" domain '---' %}
    {% registerurl "odk_media_install" domain '---' %}
    {% registerurl "download_index" domain '---' %}
    {% registerurl "release_build" domain app.id '---' %}
    {% registerurl "save_copy" domain app.id %}
    {% registerurl "revert_to_copy" domain app.id %}
    {% registerurl "current_app_version" domain app.id %}
    {% registerurl "hubspot_click_deploy" %}
    {% registerurl "download_ccz" app.domain '---' %}
    {% registerurl "download_multimedia_zip" app.domain '---' %}
    {% registerurl "project_report_dispatcher" app.domain 'application_error' %}
    {% registerurl "app_data_json" app.domain '---' %}

    <div class="tab-content">
        <div class="tab-pane" id="releases">
            <!-- templates only; will be populated asynchronously -->
            <script type="text/html" class="hq-loading">
                <img src="{% static 'hqwebapp/images/ajax-loader.gif' %}" alt="loading indicator" />
                {% trans "Loading..." %}
            </script>
            <script type="text/html" class="hq-loading-error">
                <div class="alert alert-danger">
                    {% trans "Oops, there was a problem loading this section. Please try again." %}
                </div>
                <button class="btn btn-primary reload">
                    {% trans "Try again" %}
                </button>
            </script>
        </div>
        <div class="tab-pane" id="app-settings">
            {% include "app_manager/v1/partials/app-settings.html" %}
        </div>
        {% include 'app_manager/v1/languages.html' %}

        {% if app.get_doc_type == "Application" %}
            <div class="tab-pane multimedia" id="multimedia">
                <div data-bind="if: load_state() === 'loading'">
                    <img src="{% static 'hqwebapp/images/ajax-loader.gif' %}" alt="loading indicator" />
                    {% trans "Loading ..." %}
                </div>
                <div data-bind="html: multimedia_page_html"></div>
                <div data-bind="if: load_state() === 'error'">
                    <button class="btn btn-default" data-bind="click: load_if_necessary">{% trans "Try again" %}</button>
                </div>
            </div>

        {% endif %}
        <div class="tab-pane{% if copy_app_form.is_bound %} active{% endif %}" id="copy-app-form">
            {% if linked_apps_enabled %}
            <div class="tabbable">
                <ul class="nav nav-tabs">
                    <li class="active"><a href="#copy-tab" data-toggle="tab">{% trans "Copy Application" %}</a></li>
                    <li><a href="#whitelist-tab" data-toggle="tab">{% trans "Linked Project Whitelist" %}</a></li>
                </ul>
                <div class="spacer"></div>
                <div class="tab-content">
                    <div id="copy-tab" class="tab-pane active">
            {% endif %}
                        <form class="form form-horizontal" method="post" action="{% url "copy_app" domain %}">
                            {% crispy copy_app_form %}
                        </form>
                        {{ request|toggle_tag_info:"EXPORT_ZIPPED_APPS" }}
                        {% if request|toggle_enabled:"EXPORT_ZIPPED_APPS" %}
                            <h3>Export compressed application</h3>
                            <form action="{% url "gzip_app" domain app.id %}" method="POST">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-arrow-down"></i>
                                    {% trans "Download" %}
                                </button>
                            </form>
                        {% endif %}
            {% if linked_apps_enabled %}
                    </div>
                    <div id="whitelist-tab" class="tab-pane">
                    <div class="help-block">
                        {% blocktrans %}
                            Project spaces on this list are able to update linked applications
                            with new changes to this application. Project spaces are automatically added to
                            this list when this application is copied as a linked application to that project
                            space. If you would like to prevent a project from making future updates,
                            you can remove them from the list here.
                        {% endblocktrans %}
                    </div>
                    <div data-bind="saveButton: saveButton"></div>
                    <table class="table">
                        <thead>
                            <tr class="row">
                                <th></th>
                                <th>{% trans "Project Space" %}</th>
                            </tr>
                        </thead>
                        <tbody data-bind="foreach: linkedDomains">
                            <tr class="row">
                                <td class="col-sm-1"><a href="#"><i class="fa fa-remove" data-bind="click: $root.removeDomain"></i></a></td>
                                <td class="col-sm-11"><span data-bind="text: $data"></span></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="tab-pane" id="delete">
            <h3>{% trans "Delete Application" %}</h3>
            <form action="{% url "delete_app" domain app.id %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger disable-on-submit">
                    <i class="fa fa-trash"></i>
                    {% trans "Delete this application" %}
                </button>
            </form>
        </div>
    </div>
{% endblock %}

{% block modals %}{{ block.super }}
{% for uploader in uploaders %}
{% include 'hqmedia/partials/multimedia_uploader.html' %}
{% endfor %}
{% include 'app_manager/v1/partials/password_setter_modal.html' %}
{% include 'app_manager/v1/partials/toggle_diff_modal.html' %}
{% endblock %}
